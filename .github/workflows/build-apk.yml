name: æ„å»º Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk wget \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev libtinfo5 \
          cmake libffi-dev libssl-dev
    
    - name: å®‰è£… Buildozer å’Œ Cython
      run: |
        pip3 install --upgrade pip
        pip3 install buildozer cython==0.29.33
    
    - name: ç¼“å­˜ Buildozer å…¨å±€ç›®å½•
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-global-
    
    - name: ç¼“å­˜ Buildozer æœ¬åœ°ç›®å½•
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: buildozer-local-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-local-
    
    - name: æ„å»º APK
      run: |
        # æ¥å—æ‰€æœ‰ Android SDK licenses
        yes | buildozer android debug || true
        buildozer android debug
    
    - name: æŸ¥æ‰¾ç”Ÿæˆçš„ APK
      id: find-apk
      run: |
        APK_FILE=$(find bin -name "*.apk" -type f | head -1)
        echo "APKæ–‡ä»¶: $APK_FILE"
        echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
        if [ -f "$APK_FILE" ]; then
          echo "æ–‡ä»¶å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
        fi
    
    - name: ä¸Šä¼  APK
      uses: actions/upload-artifact@v4
      with:
        name: parkingnav-apk
        path: bin/*.apk
        retention-days: 30
    
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=$(grep "^version = " buildozer.spec | cut -d= -f2 | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»º Releaseï¼ˆä»…é™ä¸»åˆ†æ”¯ï¼‰
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
        name: è½¦ä½å¯¼èˆª v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})
        body: |
          ## ğŸš— è½¦ä½å¯¼èˆª Android APK
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹é¢çš„ APK æ–‡ä»¶
          2. ä¼ è¾“åˆ° Android è®¾å¤‡
          3. å¯ç”¨"å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"
          4. ç‚¹å‡»å®‰è£…
          
          ### ğŸ”§ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          
          ### ğŸ“± åº”ç”¨åŠŸèƒ½
          - è“ç‰™è®¾å¤‡è¿æ¥
          - è½¦ä½å¯¼èˆªæŒ‡ä»¤å‘é€
          - æ”¯æŒ Android 5.0+
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

